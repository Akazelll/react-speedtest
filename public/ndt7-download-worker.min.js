/* eslint-disable */
self.onmessage = function (ev) {
  const url = ev.data["///ndt/v7/download"];
  if (!url) return;

  let sock;
  try {
    sock = new WebSocket(url, "net.measurementlab.ndt.v7");
  } catch (e) {
    // Jika gagal connect fatal
    return;
  }

  let start = new Date().getTime();
  let previous = start;
  let totalBytes = 0;

  sock.onopen = function () {
    start = new Date().getTime();
    previous = start;
    self.postMessage({ MsgType: "start", Data: { ClientStartTime: start } });
  };

  sock.onmessage = function (ev) {
    // Hitung bytes
    if (ev.data instanceof Blob) {
      totalBytes += ev.data.size;
    } else if (typeof ev.data === "string" || ev.data.length) {
      totalBytes += ev.data.length || 0;
    }

    const now = new Date().getTime();
    if (now - previous > 250) {
      const duration = (now - start) / 1000;
      if (duration > 0) {
        const mbps = (totalBytes * 8) / duration / 1000000;
        self.postMessage({
          MsgType: "measurement",
          Source: "client",
          Data: { MeanClientMbps: mbps, ElapsedTime: duration },
        });
      }
      previous = now;
    }

    // PERBAIKAN UTAMA DI SINI:
    // Jangan parse JSON di sini. Kirim string mentah ke main thread.
    // Main thread (ndt7.min.js) yang akan melakukan JSON.parse.
    if (typeof ev.data === "string") {
      self.postMessage({
        MsgType: "measurement",
        Source: "server",
        ServerMessage: ev.data, // <--- Ini kuncinya! Jangan kirim 'Data', tapi 'ServerMessage'
      });
    }
  };

  sock.onclose = function () {
    self.postMessage({ MsgType: "complete" });
  };

  sock.onerror = function () {
    // Silent error agar tidak spam console
  };
};
