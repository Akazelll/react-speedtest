/* eslint-disable */
self.onmessage = function (ev) {
  const url = ev.data["///ndt/v7/upload"];
  if (!url) return;

  let sock;
  try {
    sock = new WebSocket(url, "net.measurementlab.ndt.v7");
  } catch (e) {
    return;
  }

  let start = new Date().getTime();
  let totalBytes = 0;
  // Buffer 8KB
  const buffer = new Uint8Array(8192);
  for (let i = 0; i < 8192; ++i) buffer[i] = Math.floor(Math.random() * 255);

  let isRunning = true;

  function uploader() {
    if (!isRunning) return;
    if (sock.readyState === WebSocket.OPEN) {
      if (sock.bufferedAmount < 8192000) {
        sock.send(buffer);
        totalBytes += 8192;
      }
      setTimeout(uploader, 0);
    } else if (sock.readyState === WebSocket.CONNECTING) {
      setTimeout(uploader, 100);
    }
  }

  sock.onopen = function () {
    start = new Date().getTime();
    self.postMessage({ MsgType: "start", Data: { ClientStartTime: start } });
    uploader();
  };

  sock.onmessage = function (ev) {
    // PERBAIKAN UTAMA DI SINI:
    if (typeof ev.data === "string") {
      self.postMessage({
        MsgType: "measurement",
        Source: "server",
        ServerMessage: ev.data, // <--- Kirim raw string
      });
    }
  };

  const timer = setInterval(() => {
    if (!isRunning) {
      clearInterval(timer);
      return;
    }
    if (sock.readyState === WebSocket.OPEN) {
      const now = new Date().getTime();
      const duration = (now - start) / 1000;
      if (duration > 0) {
        const mbps = (totalBytes * 8) / duration / 1000000;
        self.postMessage({
          MsgType: "measurement",
          Source: "client",
          Data: { MeanClientMbps: mbps, ElapsedTime: duration },
        });
      }
    }
  }, 250);

  sock.onclose = function () {
    isRunning = false;
    clearInterval(timer);
    self.postMessage({ MsgType: "complete" });
  };

  sock.onerror = function () {};
};
